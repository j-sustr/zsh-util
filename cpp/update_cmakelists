


__update_cmakelists() {
  local cmake_file="CMakeLists.txt"
  echo "ðŸ” Starting __update_cmakelists..."
  echo "ðŸ“‚ Target file: $cmake_file"

  if [[ ! -f $cmake_file ]]; then
    echo "âŒ No $cmake_file found in current directory: $(pwd)"
    return 1
  fi

  echo "âš™ï¸  Generating new SRCS block..."
  local new_block="set(SRCS
$(gen_cmake_srcs)
)"
  echo "ðŸ“œ New block generated:"
  echo "------------------------"
  echo "$new_block"
  echo "------------------------"

  echo "ðŸ”Ž Checking if SRCS block already exists in $cmake_file..."
  if grep -q "set(SRCS" "$cmake_file"; then
    echo "âœï¸  Existing SRCS block found, replacing (Perl-safe)â€¦"
    # Escape replacement for Perl and use a non-/ delimiter
    local escaped
    escaped=$(printf '%s' "$new_block" | perl -pe 's/([\/\\$@])/\\$1/g')
    perl -0777 -i -pe "s~set\\(SRCS.*?\\)~$escaped~s" "$cmake_file" \
      && echo "âœ… Updated SRCS block in $cmake_file" \
      || { echo "âŒ Perl replace failed"; return 1; }
  else
    echo "âž• No SRCS block found, appending new one..."
    printf "\n%s\n" "$new_block" >> "$cmake_file"
    echo "âœ… Added SRCS block to $cmake_file"
  fi

  echo "ðŸŽ‰ Finished updating $cmake_file"
}

__update_cmakelists "$@"