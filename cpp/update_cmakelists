


__update_cmakelists() {
  local cmake_file="CMakeLists.txt"
  echo "ğŸ” Starting __update_cmakelists..."
  echo "ğŸ“‚ Target file: $cmake_file"

  if [[ ! -f $cmake_file ]]; then
    echo "âŒ No $cmake_file found in current directory: $(pwd)"
    return 1
  fi

  echo "âš™ï¸  Generating new SRCS block..."
  local new_block="set(SRCS
$(gen_cmake_srcs)
)"
  echo "ğŸ“œ New block generated:"
  echo "------------------------"
  echo "$new_block"
  echo "------------------------"

  echo "ğŸ” Checking if SRCS block already exists in $cmake_file..."
  if grep -q "set(SRCS" "$cmake_file"; then
    echo "âœï¸  Existing SRCS block found, replacing (Perl-safe)â€¦"
    # Escape replacement for Perl and use a non-/ delimiter
    local escaped
    escaped=$(printf '%s' "$new_block" | perl -pe 's/([\/\\$@])/\\$1/g')
    perl -0777 -i -pe "s~set\\(SRCS.*?\\)~$escaped~s" "$cmake_file" \
      && echo "âœ… Updated SRCS block in $cmake_file" \
      || { echo "âŒ Perl replace failed"; return 1; }
  else
    echo "âŒ SRCS block not found"
    return 1
  fi

  echo "ğŸ‰ Finished updating $cmake_file"
}

__update_cmakelists "$@"